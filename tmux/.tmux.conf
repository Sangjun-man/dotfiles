# ========================================
# Prefix 설정
# ========================================
unbind C-b
set -g prefix C-a
bind C-a send-prefix

# Ctrl+Space를 보조 prefix로 추가
set -g prefix2 C-Space
bind C-Space send-prefix -2

# ========================================
# 기본 설정
# ========================================
set -g default-terminal "xterm-ghostty"
set -g bell-action any
set -g visual-bell off
set -g mouse on
setw -g mode-keys vi
set -g set-clipboard on
set -g allow-passthrough on
# mosh 호환: OSC 52 포맷을 mosh가 인식하는 c; 형식으로 강제
set -ag terminal-overrides ",xterm-256color:Ms=\\E]52;c;%p2%s\\7"
set -ag terminal-overrides ",xterm-ghostty:Ms=\\E]52;%p1%s;%p2%s\\7"
set -g base-index 1
setw -g pane-base-index 1
set -g renumber-windows on

# status bar 하단 1줄 (윈도우 좌측 / 세션 우측)
set -g status on
set -g status-position bottom
set -g status-right '#{S:#[fg=colour240]#{session_name} ,#[fg=black]#{session_name} }#[default]'
set -g status-right-length 200
set -g status-left ''

# ========================================
# 복사 모드 (vi 스타일)
# ========================================
bind -T copy-mode-vi v send-keys -X begin-selection
bind -T copy-mode-vi ㅍ send-keys -X begin-selection
bind -T copy-mode-vi C-v send-keys -X rectangle-toggle
bind -T copy-mode-vi y send-keys -X copy-pipe-and-cancel "{ printf '\\033]52;c;'; base64 | tr -d '\\n'; printf '\\a'; } > #{client_tty}"
bind -T copy-mode-vi ㅛ send-keys -X copy-pipe-and-cancel "{ printf '\\033]52;c;'; base64 | tr -d '\\n'; printf '\\a'; } > #{client_tty}"

# ========================================
# prefix 없이 단축키 (Option+키)
# ========================================
bind -n M-t new-window -c "#{pane_current_path}"
bind -n M-1 select-window -t 1
bind -n M-2 select-window -t 2
bind -n M-3 select-window -t 3
bind -n M-4 select-window -t 4
bind -n M-5 select-window -t 5
bind -n M-6 select-window -t 6
bind -n M-7 select-window -t 7
bind -n M-8 select-window -t 8
bind -n M-9 select-window -t 9
bind -n M-z resize-pane -Z
bind -n M-< switch-client -p
bind -n M-> switch-client -n

# ========================================
# 윈도우 관리
# ========================================
bind c new-window -c "#{pane_current_path}"
bind ㅊ new-window -c "#{pane_current_path}"
bind n next-window
bind ㅜ next-window
bind p previous-window
bind ㅔ previous-window

# Ctrl 조합 (한글 모드에서 Ctrl이 IME 우회)
bind C-c new-window -c "#{pane_current_path}"
bind C-n next-window
bind C-p previous-window
bind C-a last-window

# 현재 윈도우를 다른 세션으로 이동 (없으면 세션 자동 생성)
bind M command-prompt -p "Move window to session:" "if-shell '! tmux has-session -t %% 2>/dev/null' 'new-session -ds %%' ; move-window -t %%:"

# ========================================
# 패인 분할
# ========================================
bind | split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"

# ========================================
# 설정 리로드
# ========================================
bind r source-file ~/.tmux.conf \; display "Config reloaded!"
bind ㄱ source-file ~/.tmux.conf \; display "Config reloaded!"

# ========================================
# 줌 (prefix 방식도 유지)
# ========================================
# z는 tmux 기본값이라 별도 bind 불필요
bind ㅋ resize-pane -Z

# ========================================
# 플러그인 (TPM)
# ========================================
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'christoomey/vim-tmux-navigator'

# TPM 실행 (맨 아래에 위치해야 함)
run '~/.tmux/plugins/tpm/tpm'

# 플러그인 이후 스타일 덮어쓰기
set -g window-status-current-style 'fg=black'
set -g window-status-style 'fg=colour240'
